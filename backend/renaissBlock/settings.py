"""
Django settings for renaissBlock project.

Generated by 'django-admin startproject' using Django 5.2.6.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path
import os  # For environment variables and paths (PEP 8 compliant)

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Load environment variables from backend/.env if present
try:
    from dotenv import load_dotenv  # type: ignore
    load_dotenv(BASE_DIR / '.env')
except Exception:
    pass

# Ensure Django looks for project-level templates (e.g., themed allauth pages)
try:
    TEMPLATES[0]['DIRS'] = [BASE_DIR / 'templates']
except Exception:
    pass

# Template overrides (ensure project-level templates are used)
try:
    import os as _os
    TEMPLATES[0]['DIRS'] = [str(BASE_DIR / 'templates')]
    TEMPLATES[0]['APP_DIRS'] = True
except Exception:
    pass


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.getenv('DJANGO_SECRET_KEY')
if not SECRET_KEY:
    raise ValueError(
        'DJANGO_SECRET_KEY environment variable must be set. '
        'Generate one with: python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"'
    )

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.getenv('DEBUG', 'False').lower() in ('true', '1', 'yes')

# ALLOWED_HOSTS - Configure for production
ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', '127.0.0.1,localhost').split(',')


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'django.contrib.sites',
    'rb_core',  # Custom app for core functionality (avoids conflict with Python's 'core' module)
    'rest_framework',  # For building APIs (e.g., content upload FR4, fiat callbacks FR2)
    'allauth',
    'allauth.account',
    'corsheaders',
    # Future: Add apps for integrations like 'rest_framework' for APIs (FR2, FR4 in REQUIREMENTS.md)
]

# Use custom user model from rb_core for auth (FR3)
AUTH_USER_MODEL = 'rb_core.User'

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'allauth.account.middleware.AccountMiddleware',
    'rb_core.middleware.SimpleCSPMiddleware',
]

ROOT_URLCONF = 'renaissBlock.urls'

# Template configuration
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [str(BASE_DIR / 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'renaissBlock.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases
# Using SQLite for MVP to avoid costs (per SCOPE.md constraints); switch to Postgres later (ARCHITECTURE.md)
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),  # Local file-based DB
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators
# Strengthened for production security

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
        'OPTIONS': {
            'user_attributes': ('username', 'email', 'first_name', 'last_name'),
            'max_similarity': 0.7,  # Stricter similarity check
        }
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
        'OPTIONS': {
            'min_length': 12,  # Increased from default 8 to 12 characters
        }
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Security Settings (per GUIDELINES.md)
# Environment-aware HTTPS enforcement: strict in production, permissive in dev
SECURE_SSL_REDIRECT = not DEBUG  # Redirect HTTP to HTTPS in production
SECURE_HSTS_SECONDS = 31536000 if not DEBUG else 0  # 1 year HSTS in production
SECURE_HSTS_INCLUDE_SUBDOMAINS = not DEBUG  # Apply HSTS to all subdomains in production
SECURE_HSTS_PRELOAD = not DEBUG  # Enable HSTS preload list in production
SECURE_CONTENT_TYPE_NOSNIFF = True  # Prevent MIME type sniffing
SECURE_BROWSER_XSS_FILTER = True  # Enable browser XSS protection
X_FRAME_OPTIONS = 'DENY'  # Prevent clickjacking
# Content Security Policy - XSS Protection
# Remove 'unsafe-inline' for production security
CSP_DEFAULT_SRC = "'self'"
CSP_IMG_SRC = "'self' data: https://picsum.photos https://ipfs.io"
CSP_SCRIPT_SRC = "'self'"  # Removed 'unsafe-inline' for security
CSP_STYLE_SRC = "'self'"   # Removed 'unsafe-inline' for security
CSP_CONNECT_SRC = "'self' wss://api.web3auth.io https://api.web3auth.io"
SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'
SECURE_CROSS_ORIGIN_OPENER_POLICY = 'same-origin'
# No private key storage - rely on Web3Auth (FR3 in REQUIREMENTS.md)

# Placeholder for Integrations (per ARCHITECTURE.md)
# WEB3AUTH_CLIENT_ID = os.getenv('WEB3AUTH_CLIENT_ID')  # Set in env for keyless auth
# RAMP_API_KEY = os.getenv('RAMP_API_KEY')  # For fiat-to-crypto (FR2)
IPFS_API_URL = 'https://ipfs.infura.io:5001'  # Free tier for MVP (FR4)

# Future Expansion: Add moderation queue, analytics (FR7), collaboration logic (FR8)
# Ensure compliance with regulations (e.g., GDPR minimization) - no unnecessary data storage

# Web3Auth Configuration for Keyless Wallet Auth (FR3)
# SECURITY: Rotate Client ID and configure domain whitelist on Web3Auth dashboard
WEB3AUTH_CLIENT_ID = os.getenv('WEB3AUTH_CLIENT_ID', 'your_client_id_here')

# Validate Web3Auth Client ID in production
if not DEBUG and WEB3AUTH_CLIENT_ID == 'your_client_id_here':
    raise ValueError(
        'WEB3AUTH_CLIENT_ID must be set to a valid Client ID in production. '
        'Get one from https://dashboard.web3auth.io/ and configure domain whitelist.'
    )

# Prefer the auth domain JWKS for Sapphire (supports ES256)
WEB3AUTH_JWKS_URL = os.getenv('WEB3AUTH_JWKS_URL', 'https://api-auth.web3auth.io/.well-known/jwks.json')

# Web3Auth Security Best Practices:
# 1. Configure domain whitelist on Web3Auth dashboard to only allow your production domain
# 2. Use separate Client IDs for development and production
# 3. Enable session management and set appropriate timeout values
# 4. Monitor Web3Auth dashboard for suspicious activity

AUTHENTICATION_BACKENDS = [
    'django.contrib.auth.backends.ModelBackend',
    'allauth.account.auth_backends.AuthenticationBackend',
]

SITE_ID = 1

# django-allauth v65 settings using ACCOUNT_LOGIN_METHODS / ACCOUNT_SIGNUP_FIELDS
ACCOUNT_LOGIN_METHODS = { 'username': True }
ACCOUNT_SIGNUP_FIELDS = ['username*', 'email*', 'password1*', 'password2*']
# Ensure no other legacy flags present
try:
    del ACCOUNT_AUTHENTICATION_METHOD
    del ACCOUNT_USERNAME_REQUIRED
    del ACCOUNT_EMAIL_REQUIRED
except Exception:
    pass
ACCOUNT_EMAIL_VERIFICATION = 'none'
FRONTEND_ORIGIN = os.getenv('FRONTEND_ORIGIN', 'http://127.0.0.1:3000')
# Neutral redirects so dev works on both localhost and 127.0.0.1
LOGIN_REDIRECT_URL = '/'
LOGOUT_REDIRECT_URL = '/'

# CORS/CSRF for frontend (environment-based for production)
# In production, set CORS_ORIGINS env var to your production domain
# Example: CORS_ORIGINS=https://renaissblock.com,https://www.renaissblock.com
CORS_ORIGINS_ENV = os.getenv('CORS_ORIGINS', '')
if CORS_ORIGINS_ENV:
    # Production: use environment-specified origins
    CORS_ALLOWED_ORIGINS = CORS_ORIGINS_ENV.split(',')
    CSRF_TRUSTED_ORIGINS = CORS_ORIGINS_ENV.split(',')
else:
    # Development: default to localhost
    CORS_ALLOWED_ORIGINS = [
        "http://localhost:3000",
        "http://127.0.0.1:3000",
    ]
    CSRF_TRUSTED_ORIGINS = [
        "http://localhost:3000",
        "http://127.0.0.1:3000",
    ]

CORS_ALLOW_CREDENTIALS = True

# Session cookie settings for cross-origin auth
# Environment-aware: secure in production, functional in dev
SESSION_COOKIE_SAMESITE = 'Lax'  # 'Lax' works with HTTP in dev
SESSION_COOKIE_SECURE = not DEBUG  # True in production (HTTPS required)
SESSION_COOKIE_HTTPONLY = True  # Prevent JavaScript access (security)
SESSION_COOKIE_AGE = 86400  # 24 hours (improve security vs infinite sessions)
SESSION_SAVE_EVERY_REQUEST = True  # Extend session on activity
SESSION_COOKIE_NAME = 'rb_sessionid'  # Custom name (security through obscurity)

# CSRF cookie settings
CSRF_COOKIE_SAMESITE = 'Lax'
CSRF_COOKIE_SECURE = not DEBUG  # True in production (HTTPS required)
CSRF_COOKIE_HTTPONLY = False  # Must be False for SPA to read CSRF token
CSRF_COOKIE_NAME = 'rb_csrftoken'  # Custom name
# For true cross-origin: deploy both frontend and backend on same domain (e.g., api.example.com)

"""Feature flags and blockchain config

Read from environment with safe defaults for MVP (SQLite). For security, do not
store private keys in the repo. Only public identifiers (program ID, pubkeys)
may be given a default here per GUIDELINES.md.
"""
FEATURE_ANCHOR_MINT = os.getenv('FEATURE_ANCHOR_MINT', 'false').lower() in ('1', 'true', 'yes', 'on')
ANCHOR_PROGRAM_ID = os.getenv('ANCHOR_PROGRAM_ID', '9ZACvfz6GNqa7fvtXTbsWUKjgzHUeJwxg4qiG8oRB7eH')
SOLANA_RPC_URL = os.getenv('SOLANA_RPC_URL', 'https://api.devnet.solana.com')
PLATFORM_WALLET_PUBKEY = os.getenv('PLATFORM_WALLET_PUBKEY', '')
# Optional: dev-only keypair path for platform wallet signer on devnet
PLATFORM_WALLET_KEYPAIR_PATH = os.getenv('PLATFORM_WALLET_KEYPAIR_PATH', '')

# Collaborative NFT Minting Configuration
SOLANA_PLATFORM_WALLET = os.getenv('SOLANA_PLATFORM_WALLET', PLATFORM_WALLET_PUBKEY or 'DawrJxixCJ2zbTCn83YRB5kZJC6zM6N36FYqGZUzNHDA')
# SOL/USD price for converting USD amounts to lamports (should use oracle in production)
SOL_PRICE_USD = os.getenv('SOL_PRICE_USD', '100.00')
# Enable collaborative minting feature
FEATURE_COLLABORATIVE_MINTING = os.getenv('FEATURE_COLLABORATIVE_MINTING', 'true').lower() in ('1', 'true', 'yes', 'on')

# Stripe Payment Configuration
STRIPE_SECRET_KEY = os.getenv('STRIPE_SECRET_KEY', '')
STRIPE_PUBLISHABLE_KEY = os.getenv('STRIPE_PUBLISHABLE_KEY', '')
STRIPE_WEBHOOK_SECRET = os.getenv('STRIPE_WEBHOOK_SECRET', '')

# Application URLs for Stripe redirects
FRONTEND_URL = os.getenv('FRONTEND_URL', 'http://127.0.0.1:3000')
BACKEND_URL = os.getenv('BACKEND_URL', 'http://127.0.0.1:8000')

# DRF throttling for public endpoints
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.SessionAuthentication',
    ],
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle',
    ],
    'DEFAULT_THROTTLE_RATES': {
        # General API throttles (relaxed in DEBUG for SPA polling)
        'anon': '600/min' if DEBUG else '60/min',
        'user': '600/min' if DEBUG else '120/min',
        # Strict auth endpoint throttles (prevent brute force attacks)
        'auth_anon': '10/min' if DEBUG else '5/min',
        'auth_user': '20/min' if DEBUG else '10/min',
        'signup': '5/hour' if DEBUG else '3/hour',
        'password_reset': '5/hour' if DEBUG else '3/hour',
    },
    # Custom exception handler for generic error messages in production
    'EXCEPTION_HANDLER': 'rb_core.exception_handlers.custom_exception_handler',
    # Pagination for list views (prevent DoS via large result sets)
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.LimitOffsetPagination',
    'PAGE_SIZE': 50,  # Default page size
    'MAX_PAGE_SIZE': 100,  # Maximum allowed page size
}

# Upload constraints (bytes and MIME types)
MAX_UPLOAD_BYTES = int(os.getenv('MAX_UPLOAD_BYTES', str(10 * 1024 * 1024)))  # 10 MB
ALLOWED_UPLOAD_CONTENT_TYPES = set((
    'image/jpeg', 'image/png', 'image/webp',
    'application/pdf',
    'video/mp4',
))

## Duplicate guard: the above variables are defined once; keep this footer clean.
